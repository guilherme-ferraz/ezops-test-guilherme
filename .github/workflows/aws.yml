name: Deploy EC2
on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
jobs:
  cd:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Create CodeDeploy Deployment
        id: deploy
        shell: bash
        env:
          parentPath: '/home/ubuntu/'
          app: 'ezops-test-guilherme'
          fullPath: '/home/ubuntu/ezops-test-guilherme/'
          scriptPath: '/home/ubuntu/ezops-test-guilherme/scripts'
          environment: '/home/ubuntu/environments/.env.ezops.production'
          gitProject: git@github.com:guilherme-ferraz/ezops-test-guilherme.git
        run: |
          echo "${{ secrets.AWS_SSH_PEM }}" > cert.pem && \
          chmod 400 cert.pem && \
          mkdir -p ~/.ssh/ && \
          chmod 700 ~/.ssh/ && \
          ssh-keyscan -H "${{ secrets.AWS_HOST }}" >> ~/.ssh/known_hosts && \
          ssh -i 'cert.pem' ubuntu@${{ secrets.AWS_HOST }} \
          "if [ -d "${{ env.fullPath }}" ]; then
          cd ${{ env.fullPath }} && \
          git pull && \
          chmod +x ${{ env.scriptPath }}/rollingUpdate.sh && \
          ${{ env.scriptPath }}/rollingUpdate.sh path=${{ env.fullPath }} env=${{ env.environment }};
          else 
          cd ${{ env.parentPath }} && \
          git clone ${{ env.gitProject }} && \
          chmod +x ${{ env.scriptPath }}/rollingUpdate.sh && \
          ${{ env.scriptPath }}/rollingUpdate.sh path=${{ env.fullPath }} env=${{ env.environment }}; fi"
